{% extends 'base.html' %}

{% block head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/detail2.css' %}">
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/diagrama.css' %}"
    />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@5/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <title>Edición Manual</title>
{% endblock %}

{% block content %}
    <div class="main-cont animate__animated animate__fadeIn">

      <header class="head-cont">
        <div class="logo">
          <img src="{% static 'images/aeto.svg' %}" alt="logo aeto">
        </div>

        <h1 class="main-title">Edición manual</h1>
      </header>

      <form class="main__container" method="POST" id="tire-form">

        <header class="config__header">
          <h1>VEHÍCULO {{vehiculo_actual}}</h1>
        </header>

        <section class="main__wrapper">
          <div class="config__container">
         
            <div class="relative">
              <div class="absolute">
  
                {% for eje in ejes %}
  
                  {% if eje|length == 2 %}
  
                    <div class="par-llantas ejes__{{cant_ejes|safe}}">
                      <div class="tire" data-tire-id="{{eje.0.0.id}}">
                        <div class="tire__top {{eje.0.3}}">
                          <span class="tire__data">
                            {{eje.0.0.presion_actual}}
                          </span>
                        </div>
  
                        <div class="tire__medium {{eje.0.3}}">
                          <span class="tire__data">
                            {{eje.0.0.posicion}}
                          </span>
                        </div>
                        
                        <span class="icon-tire2"></span>
                        
                        <div class="tire__bottom {{eje.0.1}}">
                            <span class="tire__data">

                              {% if eje.0.4 == None %}
                                  N/A
                              {% else %}
                                  {{eje.0.4}}
                              {% endif %}
                              
                            </span>
                        </div>
                      </div>
              
                      <div class="axle">
                        <span class="axle-white"></span>
                      </div>
              
                      <div class="tire" data-tire-id="{{eje.1.0.id}}">
                        <div class="tire__top {{eje.1.3}}">
                          <span class="tire__data">
                            {{eje.1.0.presion_actual}}
                          </span>
                        </div>
  
                        <div class="tire__medium {{eje.1.3}}">
                          <span class="tire__data">
                            {{eje.1.0.posicion}}
                          </span>
                        </div>
                        
                        <span class="icon-tire2"></span>
                        
                        <div class="tire__bottom {{eje.1.1}}">
                            <span class="tire__data">
  
                              {% if eje.1.4 == None %}
                                  N/A
                              {% else %}
                                  {{eje.1.4}}
                              {% endif %}
  
                            </span>
                        </div>
                      </div>
                    </div>
  
                  {% else %}
  
                    <div class="par-doble-llanta ejes__{{cant_ejes|safe}}">
                      <div class="double-tire">
                        <div class="tire" data-tire-id="{{eje.0.0.id}}">
                          <div class="tire__top {{eje.0.3}}">
                            <span class="tire__data">
                              {{eje.0.0.presion_actual}}
                            </span>
                          </div>
  
                          <div class="tire__medium {{eje.0.3}}">
                            <span class="tire__data">
                              {{eje.0.0.presion_actual}}
                            </span>
                          </div>
                          
                          <span class="icon-tire2"></span>
                          
                          <div class="tire__bottom {{eje.0.1}}">
                              <span class="tire__data">
                                
                                {% if eje.0.4 == None %}
                                  N/A
                              {% else %}
                                  {{eje.0.4}}
                              {% endif %}
  
                              </span>
                          </div>
                        </div>
                        <div class="tire" data-tire-id="{{eje.1.0.id}}">
                          <div class="tire__top {{eje.1.3}}">
                            <span class="tire__data">
                              {{eje.1.0.presion_actual}}
                            </span>
                          </div>
  
                          <div class="tire__medium {{eje.1.3}}">
                            <span class="tire__data">
                              {{eje.1.0.posicion}}
                            </span>
                          </div>
                          
                          <span class="icon-tire2"></span>
                          
                          <div class="tire__bottom {{eje.1.1}}">
                              <span class="tire__data">
  
                                {% if eje.1.4 == None %}
                                  N/A
                                {% else %}
                                  {{eje.1.4}}
                                {% endif %}
                                
                              </span>
                          </div>
                        </div>
                      </div>
              
                      <div class="axle"></div>
              
                      <div class="double-tire">
                        <div class="tire" data-tire-id="{{eje.2.0.id}}">
                          <div class="tire__top {{eje.2.3}}">
                            <span class="tire__data">
                              {{eje.2.0.presion_actual}}
                            </span>
                          </div>
  
                          <div class="tire__medium {{eje.2.3}}">
                            <span class="tire__data">
                              {{eje.2.0.posicion}}
                            </span>
                          </div>
                          
                          <span class="icon-tire2"></span>
                          
                          <div class="tire__bottom {{eje.2.1}}">
                              <span class="tire__data">
                                
                                {% if eje.2.4 == None %}
                                  N/A
                                {% else %}
                                  {{eje.2.4}}
                                {% endif %}
  
                              </span>
                          </div>
                        </div>
                        <div class="tire" data-tire-id="{{eje.3.0.id}}">
                          <div class="tire__top {{eje.3.3}}">
                            <span class="tire__data">
                              {{eje.3.0.presion_actual}}
                            </span>
                          </div>
  
                          <div class="tire__medium {{eje.3.3}}">
                            <span class="tire__data">
                              {{eje.3.0.posicion}}
                            </span>
                          </div>
                          
                          <span class="icon-tire2"></span>
                          
                          <div class="tire__bottom {{eje.3.1}}">
                              <span class="tire__data">
                                
                                {% if eje.3.4 == None %}
                                  N/A
                                {% else %}
                                  {{eje.3.4}}
                                {% endif %}
  
                              </span>
                          </div>
                        </div>
                      </div>
                    </div>
  
                  {% endif %}
  
                {% endfor %}
  
              </div>
            </div>
  
          </div>
  
          <div class="forms__container">
    
            <aside class="form__container">

              <div class="relative">
                <div class="absolute form__container">
                  
                  <details class="dropdown__form">
                    <summary>KM de vehículo</summary>

                    <div class="form__group field">
                      <input
                        class="form__field"
                        type="number"
                        step="any"
                        placeholder=""
                        name="km_vehiculo"
                        autocomplete="off"
                        value = "{% if vehiculo_actual.km == None %}0{% else %}{{vehiculo_actual.km}}{% endif %}"
                      />
                      <label for="" class="form__label">
                        kM de vehículo
                      </label>
                    </div>

                  </details>
    
                  {% for eje in ejes %}
                    {% for ej in eje %}
                    
                      <div class="form__wrapper" data-item-id="{{ej.0.id}}">
                        {% if ej.5 == True %}
                        
                        
                        <!-- Start input -->
                        <div class="form__group field">
                          <input
                            class="form__field"
                            type="text"
                            placeholder="economico"
                            name="economico"
                            list="llantas_option"
                            autocomplete="off"
                            value = "{{ej.2.numero_economico.value}}"
                            required
                          />
                          <label for="economico" class="form__label">
                            Número económico
                          </label>
                          <div class="alert__error">
                            El valor no se encuentra en la lista de llantas, por favor seleccione opción una valida.
                          </div>
                          <div class="alert__warn">
                            El campo no puede estar vacio 
                          </div>
                        </div>
                        <datalist id="llantas_option">
                            
                          {% for i in llantas_actuales %}
                        
                              <option value="{{i}}">{{i}}</option>
    
                          {% endfor %}
                  
                        </datalist>
    
                        <!-- End input -->
      
                        <!-- Start input -->
                        <div class="form__group field">
                          <input
                            class="form__field"
                            type="text"
                            placeholder="producto"
                            name="producto"
                            autocomplete="off"
                            list="producto"
                            value = "{{ej.0.producto}}"
                            
                          />
                          <label for="producto" class="form__label">
                            Producto
                          </label>
                          <div class="alert__error">
                            El valor no se encuentra en la lista de productos, por favor seleccione una opción valida.
                          </div>
                          <div class="alert__warn">
                            El campo no puede estar vacio 
                          </div>
                          <datalist id="producto">
                            
                            {% for i in ej.2.producto %}
                          
                                <option value="{{i.data.label}}">{{i.data.label}}</option>
      
                            {% endfor %}
                    
                          </datalist>
                        </div>
                        <!-- End input -->
            
                        <!-- Start input -->
                        <div class="form__group field">
                          <input
                            class="form__field"
                            type="text"
                            placeholder="vida"
                            name="vida"
                            autocomplete="off"
                            list="vida"
                            value = {{ej.2.vida.value}}
                          />
                          <label for="vida" class="form__label">
                            Vida
                          </label>
                          <datalist id="vida">
      
                            {% for i in ej.2.vida %}
                          
                                <option value="{{i.data.label}}">{{i.data.label}}</option>
      
                            {% endfor %}
      
                          </datalist>
                        </div>
                        <!-- End input -->
                        
                        <!-- Start input -->
                            <div class="form__prof">
                            <div class="form__group field">
                              <input
                                class="form__field"
                                type="number"
                                max = {{ej.0.producto.profundidad_inicial}}
                                step="any"
                                placeholder="Profundidad derecha"
                                name="profundidad_derecha"
                                autocomplete="off"
                                value="{{ej.0.profundidad_derecha}}"
                              />
                              <label for="profundidad" class="form__label">
                                Profundidad Derecha
                              </label>
                            </div>

                            <div class="form__group field">
                              <input
                                class="form__field"
                                type="number"
                                max = {{ej.0.producto.profundidad_inicial}}
                                step="any"
                                placeholder="Profundidad central"
                                name="profundidad_central"
                                autocomplete="off"
                                value="{{ej.0.profundidad_central}}"
                              />
                              <label for="profundidad" class="form__label">
                                Profundidad Central
                              </label>
                            </div>

                            <div class="form__group field">
                              <input
                                class="form__field"
                                type="number"
                                max = {{ej.0.producto.profundidad_inicial}}
                                step="any"
                                placeholder="Profundidad izquierda"
                                name="profundidad_izquierda"
                                autocomplete="off"
                                value="{{ej.0.profundidad_izquierda}}"
                              />
                              <label for="profundidad" class="form__label">
                                Profundidad Izquierda
                              </label>
                            </div>
                          </div>
                        
                        <!-- End input -->

                        <!-- Start input -->
                        <div class="form__group field">
                          <input
                            class="form__field"
                            type="number"
                            step="any"
                            placeholder="profundidad"
                            name="presion"
                            autocomplete="off"
                            value="{{ej.0.presion_actual}}"
                          />
                          <label for="profundidad" class="form__label">
                            Presión
                          </label>
                        </div>
                        
                        <!-- End input -->
                        <!-- Start input -->
                    
                          <div class="form__group field">
                            <input
                              class="form__field"
                              type="text"
                              placeholder="Observaciones"
                              name="observaciones"
                              autocomplete="off"
                              {% if ej.2.observacion_1.value == None %}
                                value = ""
                              {% else %}
                                value = "{{ej.2.observacion_1.value}}"
                              {% endif %}
          
                            />
                            <label for="observaciones" class="form__label">
                              Observaciones
                            </label>
                          </div>
                          
                        <!-- End input -->   
                        <input id="ids" name="ids" type="text" value={{ej.0.id}} style="display: None">
      
                        <div>
                          <label for="reemplazar-{{ej.0.id}}" class="input-check">
                            Remplazar
                            <input type="checkbox" value="{{ej.0.id}}" name="reemplazar" id="reemplazar-{{ej.0.id}}"/>
                            <span class="checkmark"></span>
                          </label>
                        </div>
    
                        <!-- ! NO QUITAR -->
                        <input type="hidden" name="id" value="">
                        <!-- ! NO QUITAR -->
                        {% else %}
                        Agrege una inspeccion para poder hacer una edicion manual
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% endfor %}
                  {% csrf_token %}
                </div>
              </div>
              
            </aside>

            <button type="submit" class="btn btn-success" title="Enviar" aria-label="Enviar formulario">
              <span class="icon-checkmark"></span>
            </button>
          </div>
        </section>
        
      </form>
    </div>

    <template>
      <section class="modal__bg">
        <button class="btn btn-danger">
          <span class="icon-cross"></span>
        </button>
        <div class="modal">
          <h2>Modal</h2>
        </div>
      </section>
    </template>

    <script>

      document.addEventListener('DOMContentLoaded', (e) => {
        onSelectTire();
        handleForms();
        handleTire();
        // handleModal();
        confirmAlert();

        validateInputList('#llantas_option', 'economico');
        validateInputList('#producto', 'producto');
      });
      
      const validateInputList = (listItem = '', inputName = '') => {
        const list = document.querySelector(listItem).options;
        let listValues = [];

        for (let i = 0; i < list.length; i++) {
          listValues.push(list[i].value)
        }

        // Traemos todos los inputs para modificar el numero econimico
        const inputs = document.querySelectorAll(`input[name="${inputName}"]`);

        // Le asignamos el evento al escribir 
        inputs.forEach(input => {
          let isValid = false;

          input.addEventListener('keyup', (e) => {
            if (listValues.indexOf(input.value) > -1) {
              input.parentNode.querySelector('.alert__error').classList.remove('active');    
              input.parentNode.querySelector('.alert__warn').classList.remove('active');  
              document.querySelector('.btn-success').classList.remove('disabled');
              isValid = true;
            } else {
              input.parentNode.querySelector('.alert__error').classList.add('active');  
              input.focus();
              document.querySelector('.btn-success').classList.add('disabled');
              isValid = false;
            }

            if (input.value === '') {
              input.parentNode.querySelector('.alert__warn').classList.add('active');  
              document.querySelector('.btn-success').classList.add('disabled');
              isValid = false;
            }
          });
          
          input.addEventListener('keypress', (e) => {
            if (!isValid) {
              if (e.key === 'Enter') e.preventDefault();
            }
          });
        });
      }

      const noDoubleValues = (inputName = '') => {
        const elements = document.querySelectorAll(`input[name="${inputName}"]`);
        let values = [];

        elements.forEach(value => {
          values.push(value.value)
        });

        const tempArray = [...values].sort();
        let duplicate = [];

        for (let i = 0; i < tempArray.length; i++) {
          if (tempArray[i + 1] === tempArray[i]) {
            duplicate.push(tempArray[i]);
          }
        }

        if (duplicate.length > 0) {
          const alert = Swal.fire({
            title: 'Error',
            text: 'No puede haber elementos duplicados',
            icon: 'error',
            backdrop: true,
            allowOutsideClick: false,
            allowEscapeKey: false,
          })
          return true; // Si hay elementos duplicados retorna true para la validación con sweetalert
        }

        return false; // Si no hay elementos duplicados
      }

      const handleModal = async () => {
        const button = document.getElementById('vehiculo-modal');

        button.addEventListener('click', () => {
          const { value: km } = Swal.fire({
            title: 'KM de vehículo',
            input: 'number',
            inputPlaceholder: 'Introduzca el KM de vehículo',
            inputAttributes: {
              name: 'km-vehiculo',
            },
            showCloseButton: true,
            {% if vehiculo_actual.km == None %}
            inputValue: 0, // Asiganar el valor al input por defecto
            {% else %}
            inputValue: {{vehiculo_actual.km}}, // Asiganar el valor al input por defecto
            {% endif %}
            
            inputValidator: (value) => {
              if (!value) {
                return 'El valor no puede estar vacío'
              }
            }
          })
        })
      };

      const handleTire = () => {
        const buttons = document.querySelectorAll('.tire');
        const items = document.querySelectorAll('.form__wrapper');

        buttons.forEach((button) => {
          button.addEventListener('click', (e) => {
            const id = button.getAttribute('data-tire-id');

            items.forEach((item) => {
              const itemId = item.getAttribute('data-item-id');
              if (id === itemId) {
                items.forEach((item) => item.classList.remove('select'));

                item.classList.add('select');
              }
            });
          });
        });

      }

      const handleForms = () => {
        const forms = document.querySelectorAll('form');

        forms[0].addEventListener('submit', (e) => {
          if (forms[0].querySelector('input').value === '') {
            e.preventDefault();
            alert('El campo no puede estar vacío');
            forms[0].querySelector('input').focus();
          }
        });
      }

      const confirmAlert = () => {
        const form = document.getElementById('tire-form');

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const duplicate = noDoubleValues('economico');

          if (duplicate) return;

          const alert = Swal.fire({
            title: 'Confirmación',
            text: '¿Seguro que desea continuar?',
            icon: 'question',
            confirmButtonText: 'Si',
            backdrop: true,
            showDenyButton: true,
            allowOutsideClick: false,
            allowEscapeKey: false,
          }).then(res => {
            (res.value) && form.submit();
          } );
          
        });
      };

      const onSelectTire = () => {
        const tires = document.querySelectorAll('.tire');
        const hidden = document.querySelector("input[type='hidden']");

        tires.forEach(tire => {
          tire.addEventListener('click', (e) => {
            tires.forEach(tire => tire.classList.remove('select'));

            hidden.value = tire.getAttribute('id');

            tire.classList.add('select');
          });
        });
      };

    </script>
{% endblock %}